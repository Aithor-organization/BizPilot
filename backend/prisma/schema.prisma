// Prisma Schema for BizPilot Platform
// OmniDesk 모델(Od*) + BizPilot 신규 모델(Bp*)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// User & Authentication (OmniDesk 재사용)
// ============================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String?   @map("password_hash")
  name            String?
  role            String    @default("USER")
  emailVerifiedAt DateTime? @map("email_verified_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  refreshTokens   RefreshToken[]
  odTenants       OdTenant[]
  odTenantMembers OdTenantMember[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  tokenHash   String   @unique @map("token_hash")
  tokenFamily String   @map("token_family")
  version     Int      @default(0)
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")
  isRevoked   Boolean  @default(false) @map("is_revoked")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenFamily])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// OmniDesk - Tenant (확장: businessType 추가)
// ============================================

model OdTenant {
  id           String       @id @default(uuid())
  name         String
  slug         String       @unique
  plan         String       @default("BASIC")
  businessType BusinessType @default(GENERAL) @map("business_type")
  settings     Json         @default("{}")
  ownerId      String       @map("owner_id")
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  owner          User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members        OdTenantMember[]
  channels       OdChannel[]
  widgets        OdWidget[]
  conversations  OdConversation[]
  documents      OdDocument[]
  brainPatterns  OdBrainPattern[]
  creditAccount  OdCreditAccount?

  // BizPilot relations
  businessProfile  BpBusinessProfile?
  services         BpService[]
  reservationSlots BpReservationSlot[]
  reservations     BpReservation[]
  customers        BpCustomer[]
  contactLogs      BpContactLog[]
  invoices         BpInvoice[]
  transactions     BpTransaction[]
  employees        BpEmployee[]
  attendances      BpAttendance[]
  leaves           BpLeave[]

  @@index([ownerId])
  @@map("od_tenants")
}

enum BusinessType {
  RESTAURANT
  SALON
  ACADEMY
  CLINIC
  RETAIL
  SERVICE
  GENERAL
}

model OdTenantMember {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  role      String   @default("AGENT")
  createdAt DateTime @default(now()) @map("created_at")

  tenant OdTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([userId])
  @@map("od_tenant_members")
}

// ============================================
// OmniDesk - Channel & Widget
// ============================================

model OdChannel {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  type      String   @default("WEB_CHAT")
  name      String
  config    Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant  OdTenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  widgets OdWidget[]

  @@index([tenantId])
  @@map("od_channels")
}

model OdWidget {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  channelId      String   @map("channel_id")
  name           String
  embedToken     String   @unique @map("embed_token")
  primaryColor   String   @default("#4F46E5") @map("primary_color")
  greeting       String   @default("안녕하세요! 무엇을 도와드릴까요?")
  position       String   @default("bottom-right")
  allowedOrigins String[] @default([]) @map("allowed_origins")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  tenant        OdTenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channel       OdChannel        @relation(fields: [channelId], references: [id], onDelete: Cascade)
  conversations OdConversation[]

  @@index([tenantId])
  @@index([channelId])
  @@map("od_widgets")
}

// ============================================
// OmniDesk - Conversation & Message
// ============================================

model OdConversation {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  widgetId      String?   @map("widget_id")
  visitorId     String    @map("visitor_id")
  visitorName   String?   @map("visitor_name")
  visitorEmail  String?   @map("visitor_email")
  status        String    @default("OPEN")
  priority      String    @default("NORMAL")
  assignedAgent String?   @map("assigned_agent")
  subject       String?
  metadata      Json      @default("{}")
  resolvedAt    DateTime? @map("resolved_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant   OdTenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  widget   OdWidget?   @relation(fields: [widgetId], references: [id])
  messages OdMessage[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([assignedAgent])
  @@index([visitorId])
  @@map("od_conversations")
}

model OdMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderType     String
  senderId       String?  @map("sender_id")
  content        String
  contentType    String   @default("text") @map("content_type")
  confidence     Float?
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation OdConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("od_messages")
}

// ============================================
// OmniDesk - Knowledge (RAG)
// ============================================

model OdDocument {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  title      String
  fileName   String   @map("file_name")
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  filePath   String?  @map("file_path")
  content    String?
  status     String   @default("PROCESSING")
  chunkCount Int      @default(0) @map("chunk_count")
  error      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant OdTenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chunks OdKnowledgeChunk[]

  @@index([tenantId])
  @@index([status])
  @@map("od_documents")
}

model OdKnowledgeChunk {
  id         String                   @id @default(uuid())
  documentId String                   @map("document_id")
  tenantId   String                   @map("tenant_id")
  content    String
  chunkIndex Int                      @map("chunk_index")
  tokenCount Int                      @default(0) @map("token_count")
  embedding  Unsupported("vector(1536)")?
  metadata   Json                     @default("{}")
  createdAt  DateTime                 @default(now()) @map("created_at")

  document OdDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@map("od_knowledge_chunks")
}

// ============================================
// OmniDesk - Brain (자가 학습)
// ============================================

model OdBrainPattern {
  id                   String    @id @default(uuid())
  tenantId             String    @map("tenant_id")
  type                 String
  context              String
  content              String
  confidence           Float     @default(0.8)
  tags                 String[]  @default([])
  hitCount             Int       @default(0) @map("hit_count")
  lastHitAt            DateTime? @map("last_hit_at")
  sourceConversationId String?   @map("source_conversation_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  tenant OdTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type])
  @@index([tenantId, confidence(sort: Desc)])
  @@map("od_brain_patterns")
}

// ============================================
// OmniDesk - Credit (크레딧 결제)
// ============================================

model OdCreditAccount {
  id        String   @id @default(uuid())
  tenantId  String   @unique @map("tenant_id")
  balance   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       OdTenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions OdCreditTransaction[]

  @@map("od_credit_accounts")
}

model OdCreditTransaction {
  id            String   @id @default(uuid())
  accountId     String   @map("account_id")
  type          String
  amount        Int
  balanceAfter  Int      @map("balance_after")
  description   String?
  referenceId   String?  @map("reference_id")
  referenceType String?  @map("reference_type")
  createdAt     DateTime @default(now()) @map("created_at")

  account OdCreditAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, createdAt(sort: Desc)])
  @@index([referenceId])
  @@map("od_credit_transactions")
}

// ============================================
// BizPilot - Business Profile (업종 프로필)
// ============================================

model BpBusinessProfile {
  id           String   @id @default(cuid())
  tenantId     String   @unique @map("tenant_id")
  businessName String   @map("business_name")
  ownerName    String?  @map("owner_name")
  bizNumber    String?  @map("biz_number")
  address      String?
  phone        String?
  openTime     String?  @default("09:00") @map("open_time")
  closeTime    String?  @default("18:00") @map("close_time")
  closedDays   Int[]    @default([]) @map("closed_days")
  currency     String   @default("KRW")
  timezone     String   @default("Asia/Seoul")
  settings     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant OdTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("bp_business_profiles")
}

// ============================================
// BizPilot - Reservation (예약)
// ============================================

model BpService {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  price       Int
  duration    Int
  category    String?
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant       OdTenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservations BpReservation[]
  invoiceItems BpInvoiceItem[]

  @@index([tenantId])
  @@map("bp_services")
}

model BpReservationSlot {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  dayOfWeek   Int      @map("day_of_week")
  startTime   String   @map("start_time")
  endTime     String   @map("end_time")
  slotMinutes Int      @default(30) @map("slot_minutes")
  maxBookings Int      @default(1) @map("max_bookings")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant OdTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
  @@map("bp_reservation_slots")
}

model BpReservation {
  id         String            @id @default(cuid())
  tenantId   String            @map("tenant_id")
  customerId String?           @map("customer_id")
  serviceId  String?           @map("service_id")
  employeeId String?           @map("employee_id")
  date       DateTime
  startTime  String            @map("start_time")
  endTime    String            @map("end_time")
  status     ReservationStatus @default(PENDING)
  note       String?
  source     String?           @default("MANUAL")
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")

  tenant   OdTenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer BpCustomer? @relation(fields: [customerId], references: [id])
  service  BpService?  @relation(fields: [serviceId], references: [id])
  employee BpEmployee? @relation(fields: [employeeId], references: [id])

  @@index([tenantId, date])
  @@index([tenantId, status])
  @@index([customerId])
  @@index([employeeId])
  @@map("bp_reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================
// BizPilot - CRM (고객)
// ============================================

model BpCustomer {
  id          String    @id @default(cuid())
  tenantId    String    @map("tenant_id")
  name        String
  phone       String?
  email       String?
  birthDate   DateTime? @map("birth_date")
  gender      String?
  tags        String[]  @default([])
  note        String?
  totalVisits Int       @default(0) @map("total_visits")
  totalSpent  Int       @default(0) @map("total_spent")
  lastVisitAt DateTime? @map("last_visit_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant       OdTenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservations BpReservation[]
  contactLogs  BpContactLog[]
  invoices     BpInvoice[]

  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, name])
  @@map("bp_customers")
}

model BpContactLog {
  id         String      @id @default(cuid())
  tenantId   String      @map("tenant_id")
  customerId String      @map("customer_id")
  type       ContactType
  content    String
  createdBy  String?     @map("created_by")
  createdAt  DateTime    @default(now()) @map("created_at")

  tenant   OdTenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer BpCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([tenantId])
  @@map("bp_contact_logs")
}

enum ContactType {
  VISIT
  CALL
  MESSAGE
  EMAIL
  NOTE
}

// ============================================
// BizPilot - Invoice (견적/계산서)
// ============================================

model BpInvoice {
  id            String        @id @default(cuid())
  tenantId      String        @map("tenant_id")
  customerId    String?       @map("customer_id")
  invoiceNumber String        @map("invoice_number")
  type          InvoiceType   @default(ESTIMATE)
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now()) @map("issue_date")
  dueDate       DateTime?     @map("due_date")
  subtotal      Int           @default(0)
  taxAmount     Int           @default(0) @map("tax_amount")
  totalAmount   Int           @default(0) @map("total_amount")
  note          String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant   OdTenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer BpCustomer? @relation(fields: [customerId], references: [id])
  items    BpInvoiceItem[]

  @@index([tenantId])
  @@index([tenantId, invoiceNumber])
  @@index([customerId])
  @@map("bp_invoices")
}

model BpInvoiceItem {
  id          String     @id @default(cuid())
  invoiceId   String     @map("invoice_id")
  serviceId   String?    @map("service_id")
  description String
  quantity    Int        @default(1)
  unitPrice   Int        @map("unit_price")
  amount      Int
  sortOrder   Int        @default(0) @map("sort_order")

  invoice BpInvoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service BpService? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@map("bp_invoice_items")
}

enum InvoiceType {
  ESTIMATE
  TAX_INVOICE
  RECEIPT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// BizPilot - Report (매출/지출)
// ============================================

model BpTransaction {
  id            String          @id @default(cuid())
  tenantId      String          @map("tenant_id")
  type          TransactionType
  category      String
  description   String
  amount        Int
  date          DateTime        @default(now())
  referenceId   String?         @map("reference_id")
  referenceType String?         @map("reference_type")
  createdBy     String?         @map("created_by")
  createdAt     DateTime        @default(now()) @map("created_at")

  tenant OdTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, date])
  @@index([tenantId, type])
  @@index([tenantId, category])
  @@map("bp_transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

// ============================================
// BizPilot - HR (직원 관리)
// ============================================

model BpEmployee {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  userId    String?   @map("user_id")
  name      String
  phone     String?
  email     String?
  role      String?
  payType   PayType   @default(HOURLY) @map("pay_type")
  payRate   Int       @default(0) @map("pay_rate")
  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant       OdTenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservations BpReservation[]
  attendances  BpAttendance[]
  leaves       BpLeave[]

  @@index([tenantId])
  @@map("bp_employees")
}

model BpAttendance {
  id           String           @id @default(cuid())
  tenantId     String           @map("tenant_id")
  employeeId   String           @map("employee_id")
  date         DateTime
  clockIn      DateTime?        @map("clock_in")
  clockOut     DateTime?        @map("clock_out")
  breakMinutes Int              @default(0) @map("break_minutes")
  totalMinutes Int              @default(0) @map("total_minutes")
  status       AttendanceStatus @default(PRESENT)
  note         String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  tenant   OdTenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee BpEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId, date])
  @@index([tenantId, date])
  @@map("bp_attendances")
}

model BpLeave {
  id         String      @id @default(cuid())
  tenantId   String      @map("tenant_id")
  employeeId String      @map("employee_id")
  type       LeaveType
  startDate  DateTime    @map("start_date")
  endDate    DateTime    @map("end_date")
  days       Float       @default(1)
  reason     String?
  status     LeaveStatus @default(PENDING)
  approvedBy String?     @map("approved_by")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  tenant   OdTenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee BpEmployee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([tenantId])
  @@map("bp_leaves")
}

enum PayType {
  HOURLY
  MONTHLY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}
